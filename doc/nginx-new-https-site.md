Nginx new https site
=============
2019-06-25


Here are the steps to add a new php site to an existing nginx server.


- The nginx pre-conf
- SSL certificate
- The nginx full conf


The nginx pre-conf
-------------
Do this step if your nginx website is not up and running.
 


```nginx
server{
	listen 80;
	root /home/me/mysite.com/app/www;
	server_name mysite.com;
	
	location / {
		return 200 "Hello from NGINX";
	}
}

```


Reload nginx:

- nginx -t (check syntax)
- nginx -s reload



SSL certificate
--------------

We will use certbot for generating ssl certificate.
If certbot is not installed, install it with the following

### Certbot installation

Execute the certbot commands (https://certbot.eff.org/lets-encrypt/ubuntubionic-nginx)
do this as your user (i.e. not root):

```bash
$ sudo apt-get update
$ sudo apt-get install software-properties-common
$ sudo add-apt-repository universe
$ sudo add-apt-repository ppa:certbot/certbot
$ sudo apt-get update
$ sudo apt-get install certbot python-certbot-nginx 
```


### Creating https certificate with certbot

Check that your http website is up and running first.

Then, we will let certbot generate the certificates.


```bash
sudo certbot certonly --nginx
```

This will generate the following files:


- /etc/letsencrypt/live/mysite.com/fullchain.pem    	(certificate)
- /etc/letsencrypt/live/mysite.com/key.pem.  			(key)
   


Then handle the auto certificate renewal:


```bash
crontab -e

---
@daily certbot renew
```


To generate the certificates only (no configuration), use the certonly option:

```bash
certbot certonly -d yourdomain.com
```




The nginx full conf
----------------

Copy, paste, and replace mysite.com by your site.
(Using vim, type :%s/mysite.com/yoursite.com/g).

Also rewrite the root directive.



```nginx
server {

        listen 80;
        listen [::]:80;
        server_name mysite.com;

        # Prevent site from being displayed under a different domain (by creating another domain pointing to our server)
        return 301 https://$host$request_uri;
}


server {
    
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        ssl_certificate /etc/letsencrypt/live/mysite.com/fullchain.pem; 
        ssl_certificate_key /etc/letsencrypt/live/mysite.com/privkey.pem;
    	ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; 

        
    	include /etc/letsencrypt/options-ssl-nginx.conf; 
    	# The include above should define all commented directives below (last check 2019-06-25)
        # ssl_session_cache shared:SSL:50m;
        # ssl_session_timeout 1d; 
        # ssl_protocols TLSv1.2;
        # ssl_prefer_server_ciphers on; 
        # ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';



        ssl_session_tickets off;






        ##
        # Security settings
        ##

        # Avoid iframes for clickjacking attacks
        # add_header X-Frame-Options DENY;
        add_header X-Frame-Options SAMEORIGIN;

        # Avoid mime type sniffing
        add_header X-Content-Type-Options nosniff;

        # Avoid certain type of XSS attacks (if browser understands it)
        add_header X-XSS-Protection "1;mode=block";

        # HSTS (ngx_http_headers_module is required) (15768000 seconds = 6 months)
        add_header Strict-Transport-Security max-age=15768000;
        # OCSP Stapling ---
        # fetch OCSP records from URL in ssl_certificate and cache them
        ssl_stapling on;
        ssl_stapling_verify on;



        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /home/me/mysite.com/app/www;

        # Add index.php to the list if you are using PHP
        index index.php index.html;

        server_name mysite.com;

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                #try_files $uri $uri/ =404;
                try_files $uri $uri/ /index.php?$query_string;
        }
        # pass PHP scripts to FastCGI server
        location ~ \.php$ {
                include snippets/fastcgi-php.conf;

                # With php-fpm (or other unix sockets):
                fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;

        }

        location ~* \.(jpg|jpeg|gif|png|css|js|ico|xml)$ {
                access_log        off;
                add_header Cache-Control public;
                add_header Pragma public;
                add_header Vary Accept-Encoding;
                expires 365d;

        }



        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        location ~ /\.ht {
                deny all;
        }

        location ~ /\.git {
                deny all;
        }
}
```









